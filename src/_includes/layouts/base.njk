<!DOCTYPE html>
<html lang="en" data-path-prefix="{{ '/' | url }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if title %}{{ title }} | {{ site.title }}{% else %}{{ site.seoTitle }}{% endif %}</title>
    <meta name="description" content="{{ description | default(site.description) }}">
    <meta name="robots" content="index,follow,max-image-preview:large">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ '/apple-touch-icon.png' | url }}">
    <link rel="icon" href="{{ '/favicon.svg' | url }}" type="image/svg+xml">
    <link rel="icon" href="{{ '/favicon.ico' | url }}">
    {% set canonicalUrl = canonicalPath | default(page.url) %}
    {% if site.pathPrefix %}
      {% set prefix = site.pathPrefix %}
      {% if canonicalUrl | startsWith(prefix ~ '/') %}
        {% set canonicalUrl = canonicalUrl | replace(prefix ~ '/', '/') %}
      {% elseif canonicalUrl == prefix %}
        {% set canonicalUrl = '/' %}
      {% elseif canonicalUrl | startsWith(prefix) %}
        {% set canonicalUrl = canonicalUrl | replace(prefix, '') %}
      {% endif %}
    {% endif %}
    {% if canonicalUrl == '' %}
      {% set canonicalUrl = '/' %}
    {% elseif not (canonicalUrl | startsWith('/')) %}
      {% set canonicalUrl = '/' ~ canonicalUrl %}
    {% endif %}
    <link rel="canonical" href="{{ site.host }}{{ canonicalUrl }}">
    <meta name="theme-color" content="#0f172a">
    {% if head_extra %}{{ head_extra | safe }}{% endif %}
    <link rel="stylesheet" href="{{ '/assets/css/styles.css' | url }}">
    <link rel="stylesheet" href="{{ '/css/dashboard.css' | url }}">
  </head>
  <body{% if seriesKey %} data-journey-slug="{{ seriesKey }}"{% endif %}>
    <a class="skip-link" href="#main">Skip to content</a>
    <header class="global-header">
      <div class="nav-container">
        <a class="site-title" href="{{ '/' | url }}">{{ site.seoTitle }}</a>
        <button
          class="nav-toggle"
          type="button"
          aria-expanded="false"
          aria-controls="primaryNav"
          data-nav-toggle
        >
          <span class="sr-only">Toggle navigation</span>
          <svg aria-hidden="true" viewBox="0 0 24 24">
            <path
              d="M4 7h16M4 12h16M4 17h16"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
            />
          </svg>
        </button>
        <div class="nav-right" id="primaryNav" data-nav-panel>
          <nav aria-label="Primary" class="nav-links">
            <a class="{% if page.url == '/' %}active{% endif %}" href="{{ '/' | url }}">Home</a>
            <a class="{% if page.url | startsWith('/overview') %}active{% endif %}" href="{{ '/overview/' | url }}">The Series</a>
            <a class="{% if page.url | startsWith('/design-system') %}active{% endif %}" href="{{ '/design-system/' | url }}">Design System</a>
          </nav>
          <div class="nav-utilities">
            <button
              aria-label="Toggle dark mode"
              class="theme-toggle"
              data-toggle-theme
              type="button"
              aria-pressed="false"
            >
              <svg class="icon icon-sun" aria-hidden="true" viewBox="0 0 24 24">
                <path
                  d="M12 4.75V3m0 18v-1.75M6.11 6.11 4.93 4.93m14.14 14.14-1.18-1.18M4.75 12H3m18 0h-1.75M6.11 17.89l-1.18 1.18m14.14-14.14-1.18 1.18M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"
                  stroke="currentColor"
                  stroke-width="1.7"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  fill="none"
                />
              </svg>
              <svg class="icon icon-moon" aria-hidden="true" viewBox="0 0 24 24">
                <path
                  d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79z"
                  stroke="currentColor"
                  stroke-width="1.5"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only">Toggle theme</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main id="main">{{ content | safe }}</main>

    {% if seriesKey %}
      {% include "components/series-nav.njk" %}
    {% endif %}

    <div class="progress-toast" data-progress-toast hidden aria-live="polite">
      <div class="progress-toast__body" role="status">
        <p class="progress-toast__message" data-progress-toast-message></p>
        <div class="progress-toast__actions">
          <button type="button" class="button" data-progress-toast-resume>Resume</button>
          <button type="button" class="button ghost" data-progress-toast-dismiss>Dismiss</button>
        </div>
      </div>
    </div>

    <section class="dashboard-boot container" id="cdcDashboardBoot" aria-live="polite">
      <h2>Let&rsquo;s Talk CDC Session</h2>
      <p>Sign in with your CDC account to unlock the interactive dashboard and sync module progress across devices.</p>
    </section>

    <section class="cdc-dashboard container" id="cdcDashboard" hidden aria-labelledby="cdcDashboardTitle">
      <header>
        <h2 id="cdcDashboardTitle">Let&rsquo;s Talk CDC Interactive Dashboard</h2>
        <p>Track journey completion, monitor recent activity, and export your session logs.</p>
      </header>
      <div class="dashboard-charts">
        <canvas id="cdc-progress-overall" aria-label="Overall progress" role="img"></canvas>
        <canvas id="cdc-progress-modules" aria-label="Module progress" role="img"></canvas>
      </div>
      <div class="dashboard-legend" id="progressLegend" aria-live="polite"></div>
      <div class="dashboard-footer" id="progressFooter" data-last-completed="0" aria-live="polite"></div>
      <div class="agent-console" id="agentConsole" aria-live="polite">
        <div class="agent-scroll" role="log" aria-live="polite" aria-label="CDC agent activity"></div>
      </div>
    </section>

    <div class="stats-wrapper" aria-live="polite">
      <button type="button" class="stats-chip" id="statsButton" aria-haspopup="dialog" aria-controls="sessionModal">
        <span class="sr-only">Open dashboard activity</span>
        <span aria-hidden="true">ðŸ“Š</span>
        <span class="stats-counter" id="statsCounter">0</span>
      </button>
      <div class="filter-tooltip" id="filterTooltip" role="status" aria-live="assertive">FILTER: all</div>
    </div>

    <div class="session-modal hidden" id="sessionModal" role="dialog" aria-modal="true" aria-labelledby="sessionModalTitle">
      <div class="modal-content">
        <header>
          <h2 id="sessionModalTitle">Session Activity</h2>
        </header>
        <div id="sessionDetails"></div>
        <div class="export-controls">
          <button type="button" id="exportTxt">Export TXT</button>
          <button type="button" id="exportJson">Export JSON</button>
        </div>
        <button type="button" class="button ghost" id="closeModal">Close</button>
      </div>
    </div>

    <script>
      (function () {
        const attr = document.documentElement.dataset.pathPrefix || '/';
        const prefix = attr === '/' ? '' : attr.replace(/\/$/, '');
        window.__PATH_PREFIX__ = prefix;

        if (!prefix) {
          return;
        }

        const rewriteAttribute = (element, attribute) => {
          const value = element.getAttribute(attribute);
          if (!value || value.startsWith('http') || value.startsWith('mailto:') || value.startsWith('tel:') || value.startsWith('#')) {
            return;
          }
          if (!value.startsWith('/') || value.startsWith(prefix)) {
            return;
          }
          element.setAttribute(attribute, `${prefix}${value}`);
        };

        const adjustDom = () => {
          document.querySelectorAll('a[href^="/"]').forEach((el) => rewriteAttribute(el, 'href'));
          document.querySelectorAll('img[src^="/"]').forEach((el) => rewriteAttribute(el, 'src'));
          document.querySelectorAll('script[src^="/"]').forEach((el) => rewriteAttribute(el, 'src'));
          document.querySelectorAll('form[action^="/"]').forEach((el) => rewriteAttribute(el, 'action'));
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', adjustDom, { once: true });
        } else {
          adjustDom();
        }
      })();
    </script>
    <script>
      window.CDC_MODULES = {{ series | dump | safe }};
    </script>
    <script type="module" src="{{ '/scripts/dashboard.js' | url }}"></script>
    <script type="module" src="{{ '/assets/js/app.js' | url }}"></script>
    {% if scripts %}
      {% for script in scripts %}
        <script type="module" src="{{ script | url }}"></script>
      {% endfor %}
    {% endif %}
    {% if appwrite.endpoint and appwrite.project %}
      <script>
        window.APPWRITE_ENDPOINT = {{ appwrite.endpoint | dump | safe }};
        window.APPWRITE_PROJECT = {{ appwrite.project | dump | safe }};
        window.APPWRITE_DB_ID = {{ appwrite.databaseId | dump | safe }};
        window.COL_PROGRESS_ID = {{ appwrite.progressCollectionId | dump | safe }};
        window.COL_EVENTS_ID = {{ appwrite.eventsCollectionId | dump | safe }};
      </script>
    {% endif %}
    {% if seriesKey %}
      <script>
        window.CDC_JOURNEY_SLUG = {{ seriesKey | dump | safe }};
      </script>
      <script type="module" src="{{ '/scripts/progress.js' | url }}"></script>
    {% endif %}
    <footer class="site-footer">
      <p>{{ site.copyright }}</p>
    </footer>
  </body>
</html>
